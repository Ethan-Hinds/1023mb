<html>
	<head>
		<meta charset="UTF-8" />
		<script src="https://cdn.jsdelivr.net/npm/p5@0.7.2/lib/p5.min.js"></script>
	</head>

	<body>
		<label> Number of segments</label>
		<input type = "text" id = "numSegments" value = "5">
		<label> Segment Length </label>
		<input type = "text" id = "segmentLength" value = "80">
		<br>
		<br>
	</body>


	<script>

		let tolerance = 2;

		var segments = [];
		var minAngles = {};

		class Segment {	
			constructor(x, y, length, parent, color) {
				this.x = x;
				this.y = y;
				this.length = length;
				this.color = color;

				this.endX = x;
				this.endY = y - length;
				this.angle = 0;
				this.parent = parent;
				this.child = undefined;
			}

			show() {
				strokeWeight(5);
				stroke(this.color	);
				line(this.x, this.y, this.endX, this.endY);
			}

			updatePosition() {
				if (this.parent) {
					this.x = this.parent.endX;
					this.y = this.parent.endY;
				}
				this.endX = this.x + this.length * cos(this.angle);
				this.endY = this.y - this.length * sin(this.angle);
			}

			setAngle(angle) {
				this.updatePosition();
				this.angle = angle != undefined ? angle : this.angle;
				this.child && this.child.setAngle();
			}
		}

		function setup() {
			createCanvas(700, 700);
			angleMode(DEGREES);

			let segmentLengthEl = document.querySelector("#segmentLength");
			segmentLengthEl.addEventListener("change", (event) => {
				let l = parseFloat(segmentLengthEl.value);
				for (let segment of segments) {
					segment.length = l;
				}
			});

			let numSegmentsEl = document.querySelector("#numSegments");
			numSegmentsEl.addEventListener("change", (event) => {
				let n = parseFloat(numSegmentsEl.value);
				let l = parseFloat(segmentLengthEl.value);
				segments = [];
				for (let i = 0; i < n; i += 1) {
					segments.push(new Segment(width*0.25, height/2 - 11.5, l, segments[segments.length - 1], color(random(50, 255), random(50, 255), random(50, 255))));
				}

				minAngles = {};
				for (let i = 0; i < segments.length; i += 1) {
					if (i < segments.length - 1) {
						segments[i].child = segments[i+1];
					}
					segments[i].updatePosition();
					minAngles[segments[i]] = 0;
				}
			});

			segments.push(new Segment(width*0.25, height/2 - 11.5, 60, undefined, color(random(50, 255), random(50, 255), random(50, 255))));
			segments.push(new Segment(width*0.25, height/2 - 11.5, 60, segments[segments.length-1], color(random(50, 255), random(50, 255), random(50, 255))));
			segments.push(new Segment(width*0.25, height/2 - 11.5, 60, segments[segments.length-1], color(random(50, 255), random(50, 255), random(50, 255))));
			segments.push(new Segment(width*0.25, height/2 - 11.5, 60, segments[segments.length-1], color(random(50, 255), random(50, 255), random(50, 255))));
			segments.push(new Segment(width*0.25, height/2 - 11.5, 60, segments[segments.length-1], color(random(50, 255), random(50, 255), random(50, 255))));

			for (let i = 0; i < segments.length; i += 1) {
				if (i < segments.length - 1) {
					segments[i].child = segments[i+1];
				}
				segments[i].updatePosition();
				minAngles[segments[i]] = 0;
			}

		}

		function getChildrenLength(segment) {
			let current = segment;
			let length = 0;
			while (current.child) {
				length += current.child.length;
				current = current.child;
			}
			return length;
		}

		function resetAllChildren(segment) {
			if (segment.child) {
				segment.child.setAngle(90);
				resetAllChildren(segment.child);
			}
		}

		function rotateAround(segment, minDistance) {
			while (segment.angle >= 90 - 360) {
				segment.setAngle(segment.angle - 1);
				if (dist(segment.endX, segment.endY, mouseX, mouseY) <= getChildrenLength(segment) + tolerance) {
					let lastSegment = segments[segments.length - 1];
					let distance = dist(lastSegment.endX, lastSegment.endY, mouseX, mouseY);
					if (distance < minDistance) {
						minDistance = distance;
						for (let seg of segments) {
							minAngles[seg] = seg.angle;
						}
					}
					if (distance < tolerance) {
						return true;
					}
					if (segment.child && rotateAround(segment.child, minDistance)) {
						return true;
					}
					resetAllChildren(segment);
				}
			}
			return false;
		}

		function draw() {
			background(0);

			for (let segment of segments) {
				segment.setAngle(90);
				segment.show();
			}

			let isPossible = rotateAround(segments[0], Infinity);
			if (!isPossible) {
				for (let segment of segments) {
					segment.setAngle(minAngles[segment]);
				}
			}
		}
	</script>
</html>
