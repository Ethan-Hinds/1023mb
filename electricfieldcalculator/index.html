<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.11/p5.js"></script> 
</head>

<body>

	<div id = "form">

	</div>

	<canvas> </canvas>

	<div id = "results">

	</div>

<script>

var c;
var width;
var height;
var row;
var xValues = [];
var yValues = [];
var charges = [];
var scale;
var forceRow;

var xComponents = [];
var yComponents = [];

$(document).ready(function() {

	createChargeTable();
	addCharge();

});

function createChargeTable() {

	row = 0;

	$("#form").append("<table id = 'info'> </table>");

	$("#info").append("<tr id = 'tableRow" + row + "'> </tr>");
	$("#tableRow0").append("<th> Num </th>");
	$("#tableRow0").append("<th> x (m) </th>");
	$("#tableRow0").append("<th> y (m) </th>");
	$("#tableRow0").append("<th> q (C)</th>");

	$("#form").append("<button type = 'button' onclick = 'addCharge();'> Add Charge </button>");

	$("#form").append("<button type = 'button' onclick = 'removeCharge();'> Remove Charge </button>");

	$("#form").append("<button type = 'button' onclick = 'checkData();'> Ok </button>");
}

function createForceTable() {

	forceRow = 0;

	$("#results").append("<table id = 'forces'> </table>");

	$("#forces").append("<tr id = 'forceTableRow" + forceRow + "'> </tr>");
	$("#forceTableRow0").append("<th> Charge # </th>");
	$("#forceTableRow0").append("<th> Force (N) </th>");
	$("#forceTableRow0").append("<th> Field (N/C) </th>");
	$("#forceTableRow0").append("<th> Angle (Deg) </th>");
}

function addForce(field, force, angle) {

	forceRow += 1;

	$("#forces").append("<tr id = 'forceTableRow" + forceRow + "'> </tr>");

	for (i = 0; i < 4; i += 1) {
		if ((i + 1) % 4 == 1) {
			$("#forceTableRow" + forceRow).append("<td>" + forceRow + "</td>");
		} else if ((i + 1) % 4 == 2) {
			$("#forceTableRow" + forceRow).append("<td>" + force + "</td>");
		} else if ((i + 1) % 4 == 3) {
			$("#forceTableRow" + forceRow).append("<td>" + field + "</td>");
		} else {
			$("#forceTableRow" + forceRow).append("<td>" + angle + "</td>");
		}
	}
}

function addCharge() {

	row += 1;

	$("#info").append("<tr id = 'tableRow" + row + "'> </tr>");

	for (i = 0; i < 4; i += 1) {
		if (i == 0) {
			$("#tableRow" + row).append("<td> " + row + " </td>");
		} else {
			$("#tableRow" + row).append("<td> <input type = 'text'> </td>");
		}
	}
}

function removeCharge() {

	if (row > 1) {
		$("#tableRow" + row).remove();
		row -= 1;
	}

}

function checkData() {

	xValues = [0];
	yValues = [0];
	charges = [0];

	var allNumbers = true;

	$("input").each(function(i) {
		val = $(this).val();
		if ((isNaN(val) || val.trim() == "") && allNumbers) {
			allNumbers = false;
			alert (val + " is not a valid number!");
		} else {
			if (i % 3 == 0) {
				xValues.push(parseFloat(val));
			} else if (i % 3 == 1) {
				yValues.push(parseFloat(val));
			} else {
				charges.push(parseFloat(val));
			}
		}
	});

	if (allNumbers) {
		setScale();
	}
}

function setScale() {

	var xRange = Math.max(...xValues) - Math.min(...xValues);
	var yRange = Math.max(...yValues) - Math.min(...yValues);

	scale = Math.max(xRange, yRange);

	drawCharges();
}

function drawCharges() {

	canvas = document.querySelector("canvas");
	canvas.width = window.innerHeight * 0.75;
	canvas.height = window.innerHeight * 0.75;
	width = canvas.width;
	height = canvas.height;

	c = canvas.getContext("2d");
	c.clearRect(0, 0, width, height);

	c.fillStyle = "green";
	c.fillRect(0, 0, width, height)

	c.fillStyle = "black";

	scale = width / scale;
	scale /= 2;
	scale *= 0.9;

	for (i = 1; i < xValues.length; i += 1) {
		if (charges[i] > 0) {
			c.fillStyle = "red";
		} else {
			c.fillStyle = "blue";
		}
		drawCircle((xValues[i] * scale) + width / 2, (-yValues[i] * scale) + height / 2, 5);
	}

	$("#results").children().remove();
	createForceTable();

	xValues.splice(0, 1);
	yValues.splice(0, 1);
	charges.splice(0, 1);

	calculateFields();
}

function calculateFields() {

	// i represents the index of the charge being tested, and j is that of the other charges
	for (var i = 0; i < xValues.length; i += 1) {
		xComponents = [];
		yComponents = [];
		for (var j = 0; j < xValues.length; j += 1) {
			if ( !(xValues[i] == xValues[j] && yValues[i] == yValues[j]) ) {

				var charge = charges[j];
				var radius = calculateDistance(xValues[i], yValues[i], xValues[j], yValues[j]);
				var magnitude = calculateTheField(charge, radius);

				var angle = calculateAngle(xValues[i], yValues[i], xValues[j], yValues[j]);
				angle = Math.abs(angle);

				var xComponent = magnitude * Math.cos(angle);
				var yComponent = magnitude * Math.sin(angle);

				if (xValues[i] > xValues[j] && charge < 0) {
					xComponent *= -1;
				} else if (xValues[i] < xValues[j] && charge > 0) {
					xComponent *= -1;
				}

				if (yValues[i] > yValues[j] && charge < 0) {
					yComponent *= -1;
				} else if (yValues[i] < yValues[j] && charge > 0) {
					yComponent *= -1;
				}

				xComponents.push(xComponent);
				yComponents.push(yComponent);

				console.log(i + " x " + xComponents);
				console.log(i + " y " + yComponents);

				
			}
		}

		// Now, the x and y components of the other charges are known.  Time to add them and then find the magnitude of the field.

		var netX = 0;
		var netY = 0;

		for (var k in xComponents) {
			netX += xComponents[k];
			netY += yComponents[k];
		}

		var netFieldMagnitude = Math.sqrt( (netX ** 2) + (netY ** 2) );
		var netFieldRounded = netFieldMagnitude.toPrecision(3);

		var netForce = netFieldMagnitude * charges[i];
		var netForceRounded = netForce.toPrecision(3);


		var netAngle = Math.atan(netY / netX);
		netAngle = Math.abs(netAngle);
		netAngle *= (180 / Math.PI);
		var angleRounded = netAngle.toFixed(2);

		var direction;
		if (netX > 0 && netY > 0) {
			direction = "N of E";
		} else if (netX < 0 && netY > 0) {
			direction = "N of W";
		} else if (netX < 0 && netY < 0) {
			direction = "S of W";
		} else if (netX > 0 && netY < 0) {
			direction = "S of E";
		} else if (netX > 0 && netY == 0) {
			direction = "E";
		} else if (netX < 0 && netY == 0) {
			direction = "W";
		} else if (netX == 0 && netY > 0) {
			direction = "N";
		} else if (netX == 0 && netY < 0) {
			direction = "S";
		} else {
			direction = "";
		}

		var angleText = angleRounded + " " + direction;

		console.log(i + " " + netX + " " + netY);

		addForce(netFieldRounded, netForceRounded, angleText);
	}

}

function calculateAngle(fromX, fromY, toX, toY) {
	var xDist = fromX - toX;
	var yDist = fromY - toY;
	var angle = Math.atan(yDist / xDist);
	return angle;
}


function calculateDistance(fromX, fromY, toX, toY) {
	var xSqr = (fromX - toX) ** 2;
	var ySqr = (fromY - toY) ** 2;
	return Math.sqrt(xSqr + ySqr);
}

function calculateTheField(charge, radius) {
	var k = 9e9;
	return (k * Math.abs(charge)) / (radius ** 2);
}

function drawCircle(x, y, radius) {
	c.beginPath();
	c.arc(x, y, radius, 0, 2 * Math.PI);
	c.fill();
	c.closePath();
}

</script>

<style>

table, td, th {
    border: 1px solid black;
    width: 50px;
    height: 20px;
}

table {
    border-collapse: collapse;
    width: 210px;
}

th {
    height: 50px;
}

input {
	width: 70px;
}

button {
	margin-right: 13px;
}

canvas {
	margin-top: 10px;
}

#forces {
	width: 240px;
}

</style>

</body>
</html>